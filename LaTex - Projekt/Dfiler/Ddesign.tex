\chapter{Design}

\begin{longtabu} to \linewidth{@{}l l l X[j]@{}}
    Version &    Dato &    Ansvarlig &    Beskrivelse\\[-1ex]
    \midrule
    
\label{version_Systemark}
\end{longtabu}

\section{Indledning}

  
\section{Hardware arkitektur}
I følgende afsnit beskrives hvordan blodtryksmåler systemet og nogle af dets delkomponenter er opbygget.
\\
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{Figurer/Hardware/BDD}
	\caption{Blokdiagram for blodtryksmåler systemet.}\label{labelpic}
\end{figure}

Ud af blokdiagrammet kan man se at blodtryksmåler systemet består af en transducer, en forstærker, et analogt filter, en DAQ og en computer.\\
\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{Figurer/Hardware/IBD}
	\caption{Internt blok diagram for blodtryksmåler systemet.}\label{labelpic}
\end{figure}

Ud af det interne blok diagram kan ses det at blodtrykket i form af det målte tryk kommer ind i transduceren. Transduceren som omformer det målte tryk til et spændingssignal, sender signalet vidre til forstærkeren. Fra forstærkeren sendes signalet over i det analoge filter og derfra ind i DAQ'en. Endeligt sendes det digitale signal fra DAQ'en over i en computer, der fortolker signalet som et billede, der vises til omverdenen.

\subsection{Design af forstærker}
Forstærkeren er designet med tanke på, at det er meget små spændinger der arbejdes med. Grundet dette, er en almindelig operationsforstærker fravalgt, da dens reelle indgangsimpedans er for lille. En Instrumentationsforstærkers indgangsimpedans i den virkelige verden, er højere, og den kan dermed opfange meget små signaler så som blodtryk.\\
Vejleder rådede herefter til at projektgruppen brugte instrumentationsforstærkeren INA114. Forstærkerens design kan ses på figur X.\\ 
\begin{figure}[H]
	\centering
	\includegraphics[width=0.6\textwidth]{Figurer/Hardware/Forstaerker}
	\caption{Der overordnede design af forstærkeren.}\label{labelpic}
\end{figure}
$R_{gain}$ er modstanden, som bestemmer, hvor meget forstærkning, instrumentationsforstærkeren skal give og $R_{load}$ er den belastning, der kommer efter kredsløbet. I dette tilfælde, er det, det analoge filter. For at finde $R_{gain}$’s størrelse, kræver det, at der vides, hvor meget forstærkning der er brug for. Dette findes, ved at bestemme den maksimale spænding, som transduceren kan give, i en blodtrykssituation. Dette regnestykke kan ses realiseret i ligning x.\\
\begin{figure}[H]
	\centering
	\includegraphics[width=0.8\textwidth]{Figurer/Hardware/LigningSara}
\end{figure}

Spændingen ønskes at skaleres op til DAQ’ens dynamikområde, som ligger omkring de 5V. Forstærkningsfaktoren udregnes ved simpel brøkregning. \\

\begin{figure}[H]
	\centering
	\includegraphics[width=0.3\textwidth]{Figurer/Hardware/ligningtilgain}
\end{figure}

INA114’s datasheet giver en ligning for udregning af forstærkning. Da forstærkningen er kendt, omskrives denne ligning, så modstanden $R_{gain}$’s værdi i stedet bestemmes.\\

\begin{figure}[H]
	\centering
	\includegraphics[width=0.7\textwidth]{Figurer/Hardware/omskrivningtilgain}
\end{figure}

Herefter kan den ohmske værdi af $R_{gain}$ bestemmes.\\

\begin{figure}[H]
	\centering
	\includegraphics[width=0.3\textwidth]{Figurer/Hardware/udregningafgain}
\end{figure}

\subsection{Design af analogfilter}
Filteret skulle realiseres som et aktivt 2. ordens lavpasfilter med båndbredde på 50 Hz af typen Sallen-Key med unity gain (se \ref{fig:Filter}). Filteret skulle designes som et Butterworth filter med cut off frekvens på 50 Hz. C2 skulle vælges til 680 nF og R1 = R2. Operationsforstærkeren skal være af typen OP27.  

\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{Figurer/Hardware/FilterDesign}
	\caption{Unity gain 2. ordens Sallen-Key lavpas konfiguration}
	\label{fig:Filter}
\end{figure}

Der blev valgt en dæmpningsfaktor på 1, da det ville være mest optimalt med et kritisk dæmpet signal. Ud fra hjemmesiden\footnote{http://sim.okawa-denshi.jp/en/OPseikiLowkeisan.htm} fandt vi overføringsfunktionen for Sallen-Kay lavpasfiltret:

\begin{figure}[H]
	\centering
	\includegraphics{Figurer/Hardware/ligning1}
	\label{fig:lign1}
\end{figure}

Da det er blevet opgivet at $R1=R2$, kan overføringsfunktionen forkortes: 

\begin{figure}[H]
	\centering
	\includegraphics[width=0.35\textwidth]{Figurer/Hardware/ligning2}
\end{figure}

Dernæst sammenlignes med standardformlen for overføringsfunktionen for et andet ordens filter.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.6\textwidth]{Figurer/Hardware/ligning3}
	\label{fig:lign3}
\end{figure}

Ud fra dette kan regnes komponentværdierne for R, idet

\begin{figure}[H]
	\centering
	\includegraphics[width=0.2\textwidth]{Figurer/Hardware/ligning4}
	\label{fig:lign4}
\end{figure}

Ved hjælp af mathcad isoleres R.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.85\textwidth]{Figurer/Hardware/ligning5}
	\label{fig:lign5}
\end{figure}

Dernæst kan komponentværdien for C1 udregnes, idet:

\begin{figure}[H]
	\centering
	\includegraphics[width=0.2\textwidth]{Figurer/Hardware/ligning6}
	\label{fig:lign6}
\end{figure}

Ved hjælp af mathcad isoleres C1. 

\begin{figure}[H]
	\centering
	\includegraphics[width=0.9\textwidth]{Figurer/Hardware/ligning7}
	\label{fig:lign7}
\end{figure}

Derved er komponentværdierne for kredsløbet fundet og de ses indskrevet på \ref{fig:Filter}. 

\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{Figurer/Hardware/FilterDesignMedKomponentvaerdier}
	\caption{Unity gain 2. ordens Sallen-Key lavpas konfiguration med indsatte komponentværdier.}
	\label{fig:Filter_K}
\end{figure}

Generelt er et unity gain Sallen-Key filter med equivalente capacitorer og equivalente resistore kritisk dæmpet dvs. en kvalitets faktor på 1/2. Dette kan også ses når komponentværdierne indsættes i ”Sallen-Key Low-pass Filter Design Tool”\footnote{http://sim.okawa-denshi.jp/en/OPseikiLowkeisan.htm}. Desuden ses bodeplottet nedenfor:

\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{Figurer/Hardware/Bodeplot}
	\caption[]{Bodeplot af overføringsfunktionen\footnotemark}
	\label{fig:Bodeplot}
\end{figure}
\footnotetext{http://sim.okawa-denshi.jp/en/OPseikiLowkeisan.htm}


\subsection{Grænseflader}

\section{Software arkitektur}

\subsection{GUI}

\subsection{UML klassediagram}


\subsection{Appliktationsmodel}

\subsubsection{Klassediagram}

\subsubsection{Domænemodel}
Diagrammet viser en domæne model for blodtryks systemet. Dette diagram giver et godt overblik over systemet som helhed og hvilke elementer, der indgår i systemet. Diagrammet viser hvordan brugeren interagerer med systemet og hvordan systemet forløber efter det igangsættes af bruger. 

\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{Figurer/ISE/Domaenemodel}
	\caption{Sekvensdiagram UC2}
	\label{sd UC2}
\end{figure}

\subsubsection{Sekvensdiagram}
Sekvensdiagrammet er et interaktions diagram, der viser hvordan processer i systemet forløber. Use casene ligger til baggrund for udarbejdelsen af sekvensdiagrammerne.\\ \\
Der er blevet lavet et sekvensdiagram for hver use case for at give det bedste overblik over hver handling i forhold til systemet. I sekvensdiagrammet har vi brugt virtuelle metode kald til at beskrive forløbet. I use case 2-7 er det brugeren, der interagerer med systemet og er initiator for a handlingerne bliver udført.

\begin{figure}[H]
	\centering
	\includegraphics[width=0.2\textwidth]{Figurer/ISE/sdAppModelUC2}
	\caption{Sekvensdiagram UC2}
	\label{sd UC2}
\end{figure}

Her ses det hvordan brugeren logger ind i systemet og hvordan brugeren for systemet nulpunktsjusteret. Det er brugeren, der interagerer med systemet og er initiator for at handlingerne bliver udført. 

\begin{figure}[H]
	\includegraphics[width=1\textwidth]{Figurer/ISE/sdAppModelUC3}
	\caption{Sekvensdiagram UC3}
	\label{sd UC3}
\end{figure}

Her ses det hvordan brugeren starter målingen og hvordan graferne vises på brugergrænsefalden.

\begin{figure}[H]
	\includegraphics[width=1\textwidth]{Figurer/ISE/sdAppModelUC4}
	\caption{Sekvensdiagram UC4}
	\label{sd UC4}
\end{figure}

Her til vælger brugeren om blodtryks signalet skal filtreres eller ej.

\begin{figure}[H]
	\includegraphics[width=1\textwidth]{Figurer/ISE/sdAppModelUC5}
	\caption{Sekvensdiagram UC5}
	\label{sd UC5}
\end{figure}

Det ses her hvordan brugeren justerer grænseværdierne for patientens blodtryk. Denne justering sker ud fra patientens målte blodtryk. De justerede grænseværdi ligger til grundlag for alarmen. 

\begin{figure}[H]
	\includegraphics[width=1\textwidth]{Figurer/ISE/sdAppModelUC6}
	\caption{Sekvensdiagram UC6}
	\label{sd UC6}
\end{figure}

Her ønsker brugeren at udskyde den alarm, der er opstået i systemet pga. for højt eller for lavt blodtryk.

\begin{figure}[H]
	\includegraphics[width=1\textwidth]{Figurer/ISE/sdAppModelUC7}
	\caption{Sekvensdiagram UC7}
	\label{sd UC7}
\end{figure}

Brugeren ønsker her at gemme og afslutte målingen. 

\subsubsection{Opdateret Klassediagram}
Klasse pplikationsmodellerne er udarbejdet ud fra use casene, sekvensdiagrammer og domænemodellen. Der er ligesom ved sekvensdiagrammerne lavet et klassediagram for hver use case. Der er her også brugt virtuelle metoder. 

\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{Figurer/ISE/classAppModelUC2}
	\caption{Klassediagram UC 2}
	\label{classApp UC2}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{Figurer/ISE/classAppModelUC3}
	\caption{Klassediagram UC 3}
	\label{classApp UC3}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=1.4\textwidth]{Figurer/ISE/classAppModelUC4}
	\caption{Klassediagram UC 4}
	\label{classApp UC4}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{Figurer/ISE/classAppModelUC5}
	\caption{Klassediagram UC 5}
	\label{classApp UC5}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{Figurer/ISE/classAppModelUC6}
	\caption{Klassediagram UC 6}
	\label{classApp UC6}
\end{figure}

\begin{figure}[H]
	\centering
	\includegraphics[width=1\textwidth]{Figurer/ISE/classAppModelUC7}
	\caption{Klassediagram UC 7}
	\label{classApp UC7}
\end{figure}

\section{Software implementering}
 
\subsection{Visning af EKG-signal}

\subsection{Analyse}

\subsection{Testprogram}

\subsection{Lagring i database} 

\subsubsection{Offentlig database}

\subsubsection{Privat database}







